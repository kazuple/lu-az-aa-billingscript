{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "automationAccountName": {
            "defaultValue": "LU-AA-BillingScript",
            "type": "String",
            "metadata": {
                "description": "Specify the name of your Automation Account"
            }
        },
        "automationRegion": {
            "type": "string",
            "allowedValues": [
                "uksouth",
                "westeurope",
                "southeastasia",
                "eastus2",
                "southcentralus",
                "japaneast",
                "northeurope",
                "canadacentral",
                "australiasoutheast",
                "centralindia",
                "westcentralus"
            ],
            "metadata": {
                "description": "Specify the region for your automation account"
            }
        },
        "LoopUpServiceUsername": {
            "type": "string",
            "metadata": {
                "description": "Enter your LoopUp Service account username, ex: loopup.service@contoso.com.  This will be used to query Teams to export required billing information."
            }
        },
        "LoopUpServicePassword": {
            "type": "securestring",
            "metadata": {
                "description": "Enter the password for the LoopUp Service account user. The password is encrypted during runtime and in the Automation assets."
            }
        },
        "_artifactsLocation": {
            "type": "string",
            "defaultValue": "[deployment().properties.templateLink.uri]",
            "metadata": {
                "description": "URI to artifacts location"
            }
        }
//        "jobGuid": {
//            "type": "string",
//           "metadata": {
//              "description": "GUID for the schedule creation - create a unique before deploy"
//            }
//        }
//        "baseTime": {
//        "type": "string",
//        "defaultValue": "[utcNow('u')]",
//        "metadata": {
//            "description": "Schedule will start one hour from this time."
//       }
//    }
},
    "variables": {
//        "scheduleStartTime": {
//            "startTime": "[dateTimeAdd(parameters('baseTime'), 'PT1H')]"
//        },
        "assets": {
            "aaVariables": {
                "luServiceAccountUsername": {
                    "name": "luServiceAccountUsername",
                    "description": "LoopUp Service Account: Username"
                },
                "luServiceAccountPassword": {
                    "name": "luServiceAccountPassword",
                    "description": "LoopUp Service Account: Password"
                }
            }
        },
        "luScripts": {
            "runbooks": [
                {
                    "name": "billingscript",
                    "url": "[uri(parameters('_artifactsLocation'), concat('scripts/billingscript.ps1'))]",
                    "version": "1.0.0.0",
                    "type": "PowerShell",
                    "description": "Runbook to deploy LUCT billing script to customers Azure tenant"
                }
            ]    
        },
        "MicrosoftTeams": {
            "name": "MicrosoftTeams",
            "url": "[uri(variables('modulesUri'),'microsoftteams.3.1.0.nupkg')]"
        },
        "modulesUri": {
            "type": "string",
            "defaultValue": "https://devopsgallerystorage.blob.core.windows.net/packages/",
            "metadata": {
                "description": "Default PowerShell Gallery Modules URI"
            }
        }
    },
    "resources": [
        {
            "type": "Microsoft.Automation/automationAccounts",
            "apiVersion": "2021-06-22",
            "name": "[parameters('automationAccountName')]",
            "location": "[parameters('automationRegion')]",
            "properties": {
                "sku": {
                    "name": "Basic"
                },
                "encryption": {
                    "keySource": "Microsoft.Automation",
                    "identity": {}
                }
            },
            "resources": [
                {
                    "name": "[variables('assets').aaVariables.luServiceAccountUsername.name]",
                    "type": "variables",
                    "apiVersion": "2020-01-13-preview",
                    "dependsOn": [
                        "[resourceId('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'))]"
                    ],
                    "properties": {
                        "description": "[variables('assets').aaVariables.luServiceAccountUsername.description]"
                    }
                },
                {
                    "name": "[variables('assets').aaVariables.luServiceAccountPassword.name]",
                    "type": "variables",
                    "apiVersion": "2020-01-13-preview",
                    "dependsOn": [
                        "[resourceId('Microsoft.Automation/automationAccounts/', parameters('automationAccountName'))]"
                    ],
                    "properties": {
                        "description": "[variables('assets').aaVariables.luServiceAccountPassword.description]",
                        "value": "[concat('\"',subscription().subscriptionId,'\"')]",
                        "isEncrypted": true
                    }
                }
            ]
        },
        {
            "type": "Microsoft.Automation/automationAccounts/credentials",
            "apiVersion": "2020-01-13-preview",
            "name": "[concat(parameters('automationAccountName'), '/', 'LoopUp Service Account Credentials')]",
            "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]"
            ],
            "properties": {
                "description": "LoopUp Service Account Credentials",
                "password": "[parameters('LoopUpServicePassword')]",
                "userName": "[parameters('LoopUpServiceUsername')]"
            }
        },  
//        {
//            "type": "Microsoft.Automation/automationAccounts/jobSchedules",
//            "apiVersion": "2020-01-13-preview",
//            "name": "[concat(parameters('automationAccountName'), '/', parameters('jobGuid'))]",
//            "name": "[concat(parameters('automationAccountName'), '/aa16bc60-55ea-4491-87ae-8b7177414078')]",
//            "dependsOn": [
//                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]"
//            ],
//            "properties": {
//                "runbook": {
//                    "name": "[variables('luScripts').runbooks.name]"
//                },
//                "schedule": {
//                    "name": "LoopUp Billing Script Schedule"
//                }
//            }
//        },
        {
            "type": "Microsoft.Automation/automationAccounts/modules",
            "apiVersion": "2020-01-13-preview",
            "name": "[concat(parameters('automationAccountName'), '/', variables('MicrosoftTeams').name)]",
            "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]"
            ],
            "properties": {
                "contentLink": {
                    "uri": "[variables('MicrosoftTeams').url]"
                }
            }
        },
        {
            "type": "Microsoft.Automation/automationAccounts/runbooks",
            "apiVersion": "2019-06-01",
            "name": "[concat(parameters('automationAccountName'), '/', variables('luScripts').runbooks[copyIndex()].Name)]",
            "location": "[parameters('automationRegion')]",
            "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]"
            ],
            "copy": {
                "name": "runbooksLoop",
                "count": "[length(variables('luScripts').runbooks)]"
            },
            "properties": {
                "description": "[variables('luScripts').runbooks[copyIndex()].description]",
                "runbookType": "[variables('luScripts').runbooks[copyIndex()].type]",
                "logVerbose": true,
                "logProgress": false,
                "publishContentLink": {
                    "uri": "[variables('luScripts').runbooks[copyIndex()].url]",
                    "version": "[variables('luScripts').runbooks[copyIndex()].version]"
                }
            }
        }
//        {
//            "type": "Microsoft.Automation/automationAccounts/schedules",
//           "apiVersion": "2020-01-13-preview",
//            "name": "[concat(parameters('automationAccountName'), '/LoopUp Billing Script Schedule')]",
//            "dependsOn": [
//                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]"
//            ],
//            "properties": {
//                "description": "Runs the LoopUp Cloud Telephony billing script each month on the 30th at 0300 UK time.",
//                "startTime": "[variables('scheduleStartTime')]",
//                "expiryTime": "9999-12-31T23:59:00+00:00",
//                "interval": 1,
//                "frequency": "Month",
//                "timeZone": "Europe/London",
//                "advancedSchedule": {
//                    "monthDays": [
//                        30
//                    ]
//                 }
//            }
//        }
    ]
}