{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
//        "automationAccountName": {
//            "defaultValue": "LU-AA-BillingScript",
//            "type": "String",
//            "metadata": {
//                "description": "Specify the name of your Automation Account"
//            }
//        },
//        "runbookName": {
//            "defaultValue": "BillingScript-Runbook",
//            "type": "String",
//            "metadata": {
//                "description": "Specify the runbook name of your Automation Account"
//            }
//        },
//        "scheduleName": {
//            "defaultValue": "BillingScript-Schedule",
//            "type": "String",
//            "metadata": {
//                "description": "Specify the runbook schedule name of your Automation Account"
//            }
//        },
        "rgName": {
            "type": "string",
            "defaultValue": "LoopUp-BillingScript",
            "metadata": {
                "description": "Name of the resourceGroup to create"
            }
            },
        "rgLocation": {
            "type": "string",
            "defaultValue": "[deployment().location]",
            "metadata": {
                "description": "Location for the resourceGroup"
            }
        },
        "automationRegion": {
            "type": "string",
            "allowedValues": [
                "uksouth",
                "westeurope",
                "southeastasia",
                "eastus2",
                "southcentralus",
                "japaneast",
                "northeurope",
                "canadacentral",
                "australiasoutheast",
                "centralindia",
                "westcentralus"
            ],
            "metadata": {
                "description": "Specify the region for your automation account"
            }
        },
        "LoopUpServiceUsername": {
            "type": "string",
            "metadata": {
                "description": "Enter your LoopUp Service account username, ex: loopup.service@contoso.com. This will be used to query Teams to export required billing information."
            }
        },
        "LoopUpServicePassword": {
            "type": "securestring",
            "metadata": {
                "description": "Enter the password for the LoopUp Service account user. The password is encrypted during runtime and in the Automation assets."
            }
        }
//        "schedulerJobGuid": {
//            "type": "string",
//            "defaultValue": "[newGuid()]",
//            "metadata": {
//              "description": "GUID for the schedule creation - create a unique before deploy"
//            }
//        }
//        "baseTime": {
//        "type": "string",
//        "defaultValue": "[utcNow('u')]",
//        "metadata": {
//            "description": "Schedule will start one hour from this time."
//       }
//    }
},
    "variables": {
//        "schedulerJobGuid": {
//            "guid": "[newGuid()]"
//        },
//        "scheduleStartTime": {
//            "startTime": "[dateTimeAdd(parameters('baseTime'), 'PT1H')]"
//        },
//        "assets": {
//            "aaVariables": {
//                "luServiceAccountUsername": {
//                    "name": "luServiceAccountUsername",
//                    "description": "LoopUp Service Account: Username"
//                },
//                "luServiceAccountPassword": {
//                    "name": "luServiceAccountPassword",
//                    "description": "LoopUp Service Account: Password"
//                }
//            }
//        },
        "automationAccountName": {
            "name": "LU-AA-BillingScript"
        },
        "runbookName": {
            "name": "BillingScript-Runbook"
        },
        "scheduleRunbookName": {
            "name": "BillingScript-ScheduleRunbook"
        },
        "scheduleName": {
            "name": "BillingScript-Schedule"
        },
        "luScripts": {
            "url": "https://raw.githubusercontent.com/kazuple/lu-az-aa-billingscript/main/scripts/BillingScript_Azure.ps1",
            "description": "Runbook to deploy LUCT billing script to customers Azure tenant"
        },
        "luScriptsSchedule": {
            "url": "https://raw.githubusercontent.com/kazuple/lu-az-aa-billingscript/main/scripts/BillingScript_Schedule.ps1",
            "description": "Runbook to deploy LUCT billing script schedule to customers Azure tenant"
        },
        "MicrosoftTeams": {
            "name": "MicrosoftTeams",
            "url": "https://devopsgallerystorage.blob.core.windows.net/packages/microsoftteams.3.1.0.nupkg"
        }
    },
    "resources": [
        {
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2021-04-01",
            "name": "[parameters('rgName')]",
            "location": "[parameters('rgLocation')]",
            "tags": {
                "tagName1": "tagValue1",
                "tagName2": "tagValue2"
            }
        },
        {
            "type": "Microsoft.Automation/automationAccounts",
            "apiVersion": "2021-06-22",
            "name": "[variables('automationAccountName').name]",
            "location": "[parameters('automationRegion')]",
            "properties": {
                "sku": {
                    "name": "Basic"
                },
                "encryption": {
                    "keySource": "Microsoft.Automation",
                    "identity": {}
                }
            },
            "resources": [
                {
                    "type": "Microsoft.Automation/automationAccounts/runbooks",
                    "apiVersion": "2019-06-01",
                    "name": "[concat(variables('automationAccountName').name, '/', variables('scheduleRunbookName').name)]",
                    "location": "[parameters('automationRegion')]",
                    "dependsOn": [
                        "[variables('automationAccountName').name]"
                    ],
                    "properties": {
                        "description": "[variables('luScriptsSchedule').description]",
                        "runbookType": "PowerShell",
                        "logVerbose": true,
                        "logProgress": false,
                        "publishContentLink": {
                            "uri": "[variables('luScriptsSchedule').url]",
                            "version": "1.0.0.0"
                        }
                    }
                },
                {
                    "type": "Microsoft.Automation/automationAccounts/runbooks",
                    "apiVersion": "2019-06-01",
                    "name": "[concat(variables('automationAccountName').name, '/', variables('runbookName').name)]",
                    "location": "[parameters('automationRegion')]",
                    "dependsOn": [
                        "[variables('automationAccountName').name]"
                    ],
                    "properties": {
                        "description": "[variables('luScripts').description]",
                        "runbookType": "PowerShell",
                        "logVerbose": true,
                        "logProgress": false,
                        "publishContentLink": {
                            "uri": "[variables('luScripts').url]",
                            "version": "1.0.0.0"
                        }
                    }
                },
                {
                    "type": "Microsoft.Automation/automationAccounts/credentials",
                    "apiVersion": "2020-01-13-preview",
                    "name": "[concat(variables('automationAccountName').name, '/', 'Credentials')]",
                    "dependsOn": [
                        "[variables('automationAccountName').name]"
                    ],
                    "properties": {
                        "description": "LoopUp Service Account Credentials",
                        "password": "[parameters('LoopUpServicePassword')]",
                        "userName": "[parameters('LoopUpServiceUsername')]"
                    }
                },  
                {
                    "type": "Microsoft.Automation/automationAccounts/modules",
                    "apiVersion": "2020-01-13-preview",
                    "name": "[concat(variables('automationAccountName').name, '/', variables('MicrosoftTeams').name)]",
                    "dependsOn": [
//                        "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationAccountName'))]"
                        "[variables('automationAccountName').name]"
                    ],
                    "properties": {
                        "contentLink": {
                            "uri": "[variables('MicrosoftTeams').url]"
                        }
                    }
                },
                {
                    "type": "Microsoft.Automation/automationAccounts/schedules",
                    "apiVersion": "2020-01-13-preview",
                    "name": "[concat(variables('automationAccountName').name, '/', variables('scheduleName').name)]",
                    "dependsOn": [
                        "[variables('automationAccountName').name]"
                    ],
                    "properties": {
                        "description": "Runs the LoopUp Cloud Telephony billing script each month on the 30th at 0300 UK time.",
        //                "startTime": "[variables('scheduleStartTime')]",
                        "startTime": "",
                        "expiryTime": "9999-12-31T23:59:00+00:00",
                        "interval": 1,
                        "frequency": "Month",
                        "timeZone": "Europe/London",
                        "advancedSchedule": {
                            "monthDays": [
                                30
                            ]
                        }
                    }
                }
            ]
        }
    ]
}